+++
title = "AJAX Struts File Upload Progress Meter"
date = 2006-03-21T09:25:00Z
updated = 2010-05-11T09:20:03Z
categories = ["blog"]
topics = ["blog"]
slug = "ajax-struts-file-upload-progress-meter"
url = "2006/03/ajax-struts-file-upload-progress-meter"
+++

<span style="font-size:100%;"><span style="font-family:arial;"><span style="font-size:85%;"><span style="font-style: italic;">** This Post is a work in progress, and is still being worked on, it hasn't been edited yet, and may contain errors, use at your own risk **</span></span><br /><br />Over the course of the last year or so I have been hearing a lot about AJAX, and how cool it is, and what neat stuff you can do with it. At first I wasn't too impressed, mostly because I have heard it all before. It wasn't until I saw </span><a style="font-family: arial;" href="http://maps.google.com">google maps</a><span style="font-family:arial;"> that I realized how cool it was. </span><span style="font-family:arial;">I have been itching to use Ajax ever since.</span><br /><br /><span style="font-family:arial;">My first attempt at AJAX was using the </span><a style="font-family: arial;" href="http://www.google.com/apis/maps/">Google Maps API</a><span style="font-family:arial;"> to add a map to the search results page on </span><a style="font-family: arial;" href="http://CampRate.com">CampRate.com</a><span style="font-family:arial;">. It is fairly simple, the search allows the visitor to </span><a style="font-family: arial;" href="http://camprate.com/c/citySearch/04005/BIDDEFORD-ME.html">search for campgrounds</a><span style="font-family:arial;"> given a zip code and a search radius. I search the </span><a style="font-family: arial;" href="http://CampRate.com">CampRate.com</a><span style="font-family:arial;"> database and return the campgrounds in the area, and I then add Site Markers onto the google map so that it is easier to see where the campgrounds are located. This was fairly easy to setup given the fact that Google opened up their API.</span<br /><br /><span style="font-family:arial;">Once I finished the Google Map hack, I was looking for something else to do. After looking around for a little while I thought of the perfect thing to AJAXify. On </span><a style="font-family: arial;" href="http://CampRate.com">CampRate.com</a><span style="font-family:arial;"> we allow Campground Owners to upload images of their campgrounds to the site, and campers are also allowed to upload images of their camping trips for everyone to see. The interface for this is very simple, it is just a regular File browse box and a submit button, once they upload the image, the browse box goes away and a thumbnail of the image is inserted. This is a very basic and a very late 90's way of doing things.  What a prefect thing to AJAXify.</span><br /><br /><span style="font-family:arial;">Once I knew what I was going to work on, I needed to figure out how I could improve on the design.  After a couple of revisions I came up with the new design and layout. One of the features that I thought would be good to use AJAX for, is a progress bar for showing the status of the upload.<br /></span><br />Here is what the new upload page looks like, this is where I would like to add a progress bar.<br /><br /><br /><br /></span><span style="font-weight: bold;font-family:arial;font-size:100%;"  >Progress Bar.</span><span style="font-size:100%;"><br /><span style="font-family:arial;">Before I started coding for the progress bar, I decided to search around to see if anyone else had used a progress bar before. I found a bunch of examples, </span><a style="font-family: arial;" href="http://www.air4web.com/files/upload/">PHP</a><span style="font-family:arial;">, </span><a style="font-family: arial;" href="http://sean.treadway.info/demo/upload/">Ruby</a><span style="font-family:arial;">, and a good one using </span><a style="font-family: arial;" href="http://www.telio.be/blog/2006/01/06/ajax-upload-progress-monitor-for-commons-fileupload-example/">Java + DWR</a><span style="font-family:arial;">. I decided to look at the </span><a style="font-family: arial;" href="http://www.telio.be/blog/2006/01/06/ajax-upload-progress-monitor-for-commons-fileupload-example/">Java + DWR</a><span style="font-family:arial;"> example since I was already using Java and DWR on </span><a style="font-family: arial;" href="http://CampRate.com">CampRate.com</a><span style="font-family:arial;">. The Java + </span><a style="font-family: arial;" href="http://getahead.ltd.uk/dwr/">DWR</a><span style="font-family:arial;"> example was a great start, the only problem was that it didn't use </span><a style="font-family: arial;" href="http://struts.apache.org/">Struts</a><span style="font-family:arial;"> and once the file was uploaded it changed pages. There were some comments associated with the article that mentioned how to get it to work with Struts, so I decided to take the source code from the article and play with it and see if I could get it to work with Struts.</span><br /><br /></span><span style="font-weight: bold;font-family:arial;font-size:100%;"  >What I wanted to change in the example.</span><span style="font-size:100%;"><br /></span><ul  style="font-family:arial;"><li><span style="font-size:100%;">Get the example to work with struts</span></li><li><span style="font-size:100%;">get the file to upload to a selected directory</span></li><li><span style="font-size:100%;">show the status of the file in the progress meter</span></li><li><span style="font-size:100%;">when the file is uploaded don't leave the page, stay on the same page (no redirect or refresh).</span></li></ul><span style="font-weight: bold;font-family:arial;font-size:100%;"  >What I did.</span><span style="font-size:100%;"><br /></span><ul  style="font-family:arial;"><li><span style="font-size:100%;">I downloaded the war file with source code from the article</span></li><li><span style="font-size:100%;">refactored the project directory</span></li><li><span style="font-size:100%;">changed the build script</span></li><li><span style="font-size:100%;">setup struts, log4j</span></li><li><span style="font-size:100%;">added logging statements for easier debugging</span></li></ul><span style="font-style: italic;">All of the new struts code that I added was put into a new package net.kencochrane so that you can easily see what is was originally there, and what was added in order to get struts to work with the original Code.</span><br /><br /><span style="font-size:100%;"><br /><span style="font-weight: bold;font-family:arial;" >Struts Changes</span><br /></span><ul  style="font-family:arial;"><li><span style="font-size:100%;">Added the struts libs to the lib dir in the project</span></li><li><span style="font-size:100%;">added the XML files to the config directory</span></li><li><span style="font-size:100%;">changed web.xml so that it works with struts</span></li><li><span style="font-size:100%;">created some actions, and form</span></li></ul><span style="font-size:100%;"><br /><span style="font-weight: bold;font-family:arial;" >Code Changes</span><br /></span><ul  style="font-family:arial;"><li><span style="font-size:100%;">Added a MultipartRequestHandler</span></li><li><span style="font-size:100%;">added struts actions to handle all requests.</span></li><li><span style="font-size:100%;">The example now actually stores the uploaded files to a temp directory.</span></li><li><span style="font-size:100%;">Added a new package net.kencochrane<br /></span></li></ul><span style="font-size:100%;"><br /></span><span style="font-weight: bold;font-family:arial;font-size:100%;"  >Uploading a file without leaving the page<br /></span><span style="font-size:100%;"><span style="font-family:arial;">I looked around to find a way to upload the files without leaving the page, but from what I could find, I guess you can't do this with javascript because of security reasons. The most common way to do this was to use an iFrame and use this iFrame to hold the upload form, and when the form is submitted the form gets posted like normal, and using some tricks with javascript you can make it look like the file is uploaded without ever leaving the page.</span><br /><br /><span style="font-family:arial;">I changed the index.jsp file to include an iFrame, the iFrame holds the upload form. Using javascript I was able to make it looks like the files are being uploaded without leaving the page.<br /><br />Here is what the new pages look like, the first image looks like the original form, the only difference is that the page is now using an iFrame to hold the upload form.<br /></span><br /><br /><br />File upload in progress, it displays the progress bar until it is complete, and then the bar goes away and is replaced with a status message.<br /><br /><br />The file is finished, </span><span style="font-size:100%;">progress bar is hidden, </span><span style="font-size:100%;">and the status message tells you the file status.<br /><br /><br /><br /></span><span style="font-weight: bold;font-family:arial;font-size:100%;"  >What is left to do</span><span style="font-size:100%;"><br /></span><ul  style="font-family:arial;"><li><span style="font-size:100%;">add better error checking</span></li><li><span style="font-size:100%;">Check for file being uploaded that is too large.</span></li></ul><span style="font-size:100%;"><br /></span><span style="font-weight: bold;font-family:arial;font-size:100%;"  >Now What</span><span style="font-size:100%;"><br /><span style="font-family:arial;">Now that I have the example working the way I want it (with struts, DWR, and having the file uploaded without leaving the page.) I can work on adding this code to </span><a style="font-family: arial;" href="http://CampRate.com">CampRate.com</a><span style="font-family:arial;">.</span><br /><br /><span style="font-family:arial;">The more that I think about it, I could also use this on </span><a style="font-family: arial;" href="http://PopcornMonsters.com">PopcornMonsters.com</a><span style="font-family:arial;"> as well, we allow people to add images for movies, and actors to the site, but the interface is very ugly, once I get the code written for </span><a style="font-family: arial;" href="http://CampRate.com">CampRate.com</a><span style="font-family:arial;"> I could easily spend the time and get the same code to work on </span><a style="font-family: arial;" href="http://PopcornMonsters.com">PopcornMonsters.com</a><span style="font-family:arial;">, that would make the whole adding images experience so much better.</span><br /><br /><span style="font-family:arial;">Special Thanks to Pierre-Alexandre Losson for writing the </span><a style="font-family: arial;" href="http://www.telio.be/blog/2006/01/06/ajax-upload-progress-monitor-for-commons-fileupload-example/">original Article</a><span style="font-family:arial;"> and for posting his code for everyone to use. </span><br /><br /><br /><br />I will update this post with some completed pictures once I finish up with all of the code. Feel free to post comments.<br /><br />Ken Cochrane<br />http://KenCochrane.net<br /></span><br /><br /><span style="font-weight: bold;"></span>
